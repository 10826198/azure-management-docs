---
title: Rotate SQL Managed Instance credentials (preview)
description: Rotate SQL Managed Instance credentials (preview)
services: azure-arc
ms.service: azure-arc
ms.subservice: azure-arc-data
author: GuptaSeattle
ms.author: guptapra
ms.reviewer: mikeray
ms.date: 02/14/2023
ms.topic: how-to
---

## Rotate SQL Managed Instance Credentials (preview)

This article describes how to rotate service managed credential for Azure Arc-enabled SQL Managed Instances. The credentials like agent certificates that gets generated by the service are considered as custom resources credentials managed by Azure Arc data services.

Service managed credential rotation will be an user-triggered operation initiated by the customer in case of a security issue or perioic rotation required for compliance reasons.

## Limitations

The following limitations must be considered when rotating SQL managed Instance credentials:

- SQL Server failover groups are not supported.
- Automatic pre-scheduled rotation is not supported.
- The DPAPI symmetric keys, keytab, and active directory accounts are not rotated as part of credential rotation.

## Prerequisites: 
Before you proceed with this article, you must have an Azure Arc-enabled SQL Managed Instance resource created and connect to it.

- [An Azure Arc-enabled SQL Managed Instance created](./create-sql-managed-instance.md)
- [Connect to Azure Arc-enabled SQL Managed Instance](./connect-managed-instance.md)

## How to rotate service managed credentials in a managed instance

Get current managed credentials generation from spec:

```console
kubectl get sqlmi <sqlmi-name> -o jsonpath='{.spec.update.managedCredentialsGeneration}' -n <namespace>
```
---

Update managedCredentialsGeneration to n+1, where n is current value. 

```console
updateSpec:
   desiredVersion: "v1_arc"
   managedCredentialsGeneration: n+1
```   
--- 

Run kubectl patch to update SQLMI that will generate new credentials:

```console
kubectl patch sqlmi <sqlmi-name> --namespace <namespace> --type merge --patch '{ "spec": { "update": { "managedCredentialsGeneration": <managed-credentials-generation> } } }'
```
---

The managedCredentialsGeneration will be the target generation for the system managed credentials. By updating it, credential rotation for system managed credentials will be triggered. The rest of the features like configuration, kubernetes topology will remain similar.


## How to rollback service managed credentials in a managed instance

Rollabck is same as triggering rotation of credentials where managedCredentialsGeneration will be marked as n-1 where the runningManagedCredentialsGeneration in the status of the custom resource is marked as n.This would lead to a rollback of credentials to previous version without generating them.

> [!NOTE]
> Rollback to previous credentials is supported but you can only go back to n-1 version where n is current version. 


## Next steps