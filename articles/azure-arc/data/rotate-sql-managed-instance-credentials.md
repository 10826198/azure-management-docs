---
title: Rotate SQL Managed Instance Service-managed Credentials (preview)
description: Rotate SQL Managed Instance service-managed credentials (preview)
services: azure-arc
ms.service: azure-arc
ms.subservice: azure-arc-data
author: GuptaSeattle
ms.author: guptapra
ms.reviewer: mikeray
ms.date: 03/14/2023
ms.topic: how-to
---
# Rotate SQL Managed Instance service managed Credentials (preview)

This article describes how to rotate service-managed credentials for Azure Arc-enabled SQL Managed Instances. The credentials, for example, agent certificates that gets generated by the service, are considered as custom resources' credentials managed by Azure Arc data services.

Service-managed credential rotation is a user-triggered operation that is initiated by the customer during a security issue or when periodic rotation is required for compliance.

## Limitations

The following limitations must be considered when rotating the managed instance service-managed credentials:

- SQL Server failover groups are not supported.
- Automatically pre-scheduled rotation is not supported.
- The service managed DPAPI symmetric keys, keytab, active directory accounts and service managed TDE credentials are not included in this credential rotation.
- SQL Managed Instance Business Critical tier is not supported.

## General Purpose

During a SQL Managed Instance service-managed credential rotation, the managed instance Kubernetes pod will be terminated and reprovisioned when new credentials are generated. This will cause a short amount of downtime as the new pod is created. You will need to build resiliency into your application, such as connection retry logic, to ensure minimal disruption. Read [Overview of the reliability pillar](/azure/architecture/framework/resiliency/overview) for more information on architecting resiliency and [retry guidance for Azure Services](/azure/architecture/best-practices/retry-service-specific#sql-database-using-adonet).

## Prerequisites: 
Before you proceed with this article, you must have an Azure Arc-enabled SQL Managed Instance resource created.

- [An Azure Arc-enabled SQL Managed Instance created](./create-sql-managed-instance.md)

## How to rotate service-managed credentials in a managed instance

Service-managed credentials are associated with a generation within the managed instance. To rotate all service-managed credentials for a managed instance, the generation must be increased by 1.

Run the following commands to get current service managed credentials generation from spec and generate the new generation of service managed credentials. This will trigger a service-managed credential rotation.

```console
rotateCredentialGeneration=$(($(kubectl get sqlmi <sqlmi-name> -o jsonpath='{.spec.update.managedCredentialsGeneration}' -n <namespace>) + 1)) 
```
---

```console
kubectl patch sqlmi <sqlmi-name> --namespace <namespace> --type merge --patch '{ "spec": { "update": { "managedCredentialsGeneration": '$rotateCredentialGeneration'} } }' 
```
---

The managedCredentialsGeneration will be the target generation for the service managed credentials. The rest of the features like configuration and the kubernetes topology will remain the same.


## How to roll back service managed credentials in a managed instance

> [!NOTE]
> Rollback is required when credential rotation failed for any reasons. Rollback to previous credentials generation is supported only once to n-1 where n is current generation.

Run the following two commands to get current service-managed credentials generation from spec and rollback to the previous generation of service managed credentials:

```console
rotateCredentialGeneration=$(($(kubectl get sqlmi <sqlmi-name> -o jsonpath='{.spec.update.managedCredentialsGeneration}' -n <namespace>) - 1)) 
```
---

```console
kubectl patch sqlmi <sqlmi-name> --namespace <namespace> --type merge --patch '{ "spec": { "update": { "managedCredentialsGeneration": '$rotateCredentialGeneration'} } }' 
```
---

Triggering rollback is the same as triggering a rotation of service-managed credentials except that the target generation is previous generation and does not generate a new generation or credentials.


## Next steps
- [View the SQL managed instance dashboards](azure-data-studio-dashboards.md#view-the-sql-managed-instance-dashboards)
- [View SQL Managed Instance in the Azure portal](view-arc-data-services-inventory-in-azure-portal.md)