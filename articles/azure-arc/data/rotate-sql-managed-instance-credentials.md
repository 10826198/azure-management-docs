---
title: Rotate SQL Managed Instance service managed credentials (preview)
description: Rotate SQL Managed Instance service managed credentials (preview)
services: azure-arc
ms.service: azure-arc
ms.subservice: azure-arc-data
author: GuptaSeattle
ms.author: guptapra
ms.reviewer: mikeray
ms.date: 02/14/2023
ms.topic: how-to
---

## Rotate SQL Managed Instance service managed Credentials (preview)

This article describes how to rotate service managed credential for Azure Arc-enabled SQL Managed Instances. The credentials like agent certificates that gets generated by the service are considered as custom resources credentials managed by Azure Arc data services.

Service managed credential rotation will be an user-triggered operation initiated by the customer in case of a security issue or perioic rotation required for compliance reasons.

## Limitations

The following limitations must be considered when rotating SQL managed Instance credentials:

- SQL Server failover groups are not supported.
- Automatic pre-scheduled rotation is not supported.
- The service managed DPAPI symmetric keys, keytab, active directory accounts and service managed TDE credentials are not rotated as part of credential rotation.

## General Purpose

During a SQL Managed Instance General Purpose service managed credential rotation, the pod will be terminated and reprovisioned at the new credential generation. This will cause a short amount of downtime as the new pod is created. You will need to build resiliency into your application, such as connection retry logic, to ensure minimal disruption. Read [Overview of the reliability pillar](/azure/architecture/framework/resiliency/overview) for more information on architecting resiliency and [retry guidance for Azure Services](/azure/architecture/best-practices/retry-service-specific#sql-database-using-adonet).


## Business Critical

During a service managed credential rotations for a SQL Managed Instance with more than one replica:

- The secondary replica pods are terminated and reprovisioned with new credential generation.
- After the replica's credentials are rotated, the primary will fail over to a replica that has the newest generation credentials.
- The previous primary pod is terminated and reprovisioned with new credential generation, and becomes a secondary.

There is a brief moment of downtime when the failover occurs.

## Prerequisites: 
Before you proceed with this article, you must have an Azure Arc-enabled SQL Managed Instance resource created.

- [An Azure Arc-enabled SQL Managed Instance created](./create-sql-managed-instance.md)

## How to rotate service managed credentials in a managed instance

Get current managed credentials generation from spec:

```console
kubectl get sqlmi <sqlmi-name> -o jsonpath='{.spec.update.managedCredentialsGeneration}' -n <namespace>
```
---

Update managedCredentialsGeneration to n+1, where n is current value. 

```console
update:
   desiredVersion: "v1_arc"
   managedCredentialsGeneration: n+1
```   
--- 

Run kubectl patch to update SQLMI that will generate new credentials:

```console
kubectl patch sqlmi <sqlmi-name> --namespace <namespace> --type merge --patch '{ "spec": { "update": { "managedCredentialsGeneration": <managed-credentials-generation> } } }'
```
---

The managedCredentialsGeneration will be the target generation for the service managed credentials. By updating it, credential rotation for service managed credentials will be triggered. The rest of the features like configuration, kubernetes topology will remain the same.


## How to rollback service managed credentials in a managed instance

Rollabck is same as triggering rotation of credentials that would lead to a rollback of credentials to previous generation without generating a new one.

> [!NOTE]
> Rollback is required when credential rotation failed for any reasons. Rollback to previous credentials generation is supported only once to n-1 where n is current generation.


## Next steps
