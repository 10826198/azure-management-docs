---
title: Rotate SQL Managed Instance service managed credentials (preview)
description: Rotate SQL Managed Instance service managed credentials (preview)
services: azure-arc
ms.service: azure-arc
ms.subservice: azure-arc-data
author: GuptaSeattle
ms.author: guptapra
ms.reviewer: mikeray
ms.date: 03/06/2023
ms.topic: how-to
---
# Rotate SQL Managed Instance service managed credentials (preview)

This article describes how to rotate service managed credentials for Azure Arc-enabled SQL Managed Instance. The credentials, for example, agent certificates generated by the service, are custom resource credentials managed by Azure Arc data services.

Service managed credential rotation is an operation that you initiate during a security issue or when periodic rotation required for compliance.

## Limitations

Consider the following limitations you rotate Azure Arc-enabled SQL Managed Instance credentials:

- SQL Server failover groups are not supported.
- Automatically pre-scheduled rotation is not supported.
- The service managed DPAPI symmetric keys, keytab, active directory accounts, and service managed TDE credentials are not included in this credential rotation.

## General Purpose tier

When you rotate service managed credential for a General Purpose tier SQL Managed Instance, the action terminates the pod and re-provisions it when new credentials are generated. This causes a short amount of downtime as the new pod is created. You will need to build resiliency into your application, such as connection retry logic, to ensure minimal disruption. Read [Overview of the reliability pillar](/azure/architecture/framework/resiliency/overview) for more information on resiliency and [retry guidance for Azure Services](/azure/architecture/best-practices/retry-service-specific#sql-database-using-adonet).

## Business Critical tier

During a service managed credential rotation for a SQL Managed Instance that has more than one replica:

- The secondary replica pods are terminated and re-provisioned with new credential generation.
- After the replica's credentials are rotated, the primary replica fails over to a replica that has the newest generation credentials.
- The previous primary pod is terminated and re-provisioned with new credential generation, and becomes a secondary.

There is a brief moment of downtime when the failover occurs.

## Prerequisites: 

Before you proceed with this article, you must have an Azure Arc-enabled SQL Managed Instance resource created.

- [An Azure Arc-enabled SQL Managed Instance created](./create-sql-managed-instance.md)

## How to rotate service managed credentials in a managed instance

Run the following two commands to get current service managed credentials generation from spec and generate new generation of service managed credentials:

```console
rotateCredentialGeneration=$(($(kubectl get sqlmi <sqlmi-name> -o jsonpath='{.spec.update.managedCredentialsGeneration}' -n <namespace>) + 1)) 
```


```console
kubectl patch sqlmi <sqlmi-name> --namespace <namespace> --type merge --patch '{ "spec": { "update": { "managedCredentialsGeneration": '$rotateCredentialGeneration'} } }' 
```

The `managedCredentialsGeneration` is the target generation for the service managed credentials. When you update it, the update triggers credential rotation for service managed credentials. The rest of the features like configuration, kubernetes topology remain the same.

## How to roll back service managed credentials in a managed instance

> [!NOTE]
> Rollback is required when credential rotation failed for any reasons. Rollback to previous credentials generation is supported only once to n-1 where n is current generation.

Run the following two commands to get current service managed credentials generation from spec and rollback to previous generation of service managed credentials:

```console
rotateCredentialGeneration=$(($(kubectl get sqlmi <sqlmi-name> -o jsonpath='{.spec.update.managedCredentialsGeneration}' -n <namespace>) - 1)) 
```


```console
kubectl patch sqlmi <sqlmi-name> --namespace <namespace> --type merge --patch '{ "spec": { "update": { "managedCredentialsGeneration": '$rotateCredentialGeneration'} } }' 
```


Rollback is same as triggering rotation of credentials that would lead to a rollback of credentials to previous generation without generating a new one.

## Next steps

- [View the SQL managed instance dashboards](azure-data-studio-dashboards.md#view-the-sql-managed-instance-dashboards)
- [View SQL Managed Instance in the Azure portal](view-arc-data-services-inventory-in-azure-portal.md)